<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Plano de Implementa√ß√£o - Resultado Econ√¥mico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 960px;
        line-height: 1.6;
        color: #1a202c;
      }
      h1,
      h2,
      h3 {
        color: #2c5282;
      }
      code {
        font-family: Consolas, Monaco, "Courier New", monospace;
        background-color: #f1f5f9;
        padding: 0 0.25rem;
        border-radius: 4px;
      }
      ul {
        padding-left: 1.25rem;
      }
      header,
      section {
        margin-bottom: 2.5rem;
      }
      .tag {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        margin-right: 0.5rem;
        border-radius: 999px;
        background-color: #bee3f8;
        color: #2b6cb0;
        font-size: 0.85rem;
      }
      .status {
        font-weight: bold;
        color: #2f855a;
      }
      footer {
        font-size: 0.85rem;
        color: #4a5568;
        border-top: 1px solid #e2e8f0;
        padding-top: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Plano de Implementa√ß√£o - Sistema de Resultado Econ√¥mico</h1>
      <p>
        Documento de refer√™ncia para o desenvolvimento do sistema de resultado
        econ√¥mico com base no arquivo
        <code>Balancete Consolidado 2025.xls</code>. Status atual:
        <span class="status">Autentica√ß√£o e gest√£o de empresas conclu√≠das - Processamento de Excel em desenvolvimento</span>.
      </p>
    </header>

    <section>
      <h2>Andamento do Projeto</h2>
      <ul>
        <li>Reposit√≥rio Git inicializado, conectado ao GitHub e documentado.</li>
        <li>
          Frontend Next.js configurado (TypeScript, Tailwind, React Query, Zustand) com
          suporte PWA completo (manifesto, service worker, √≠cones e fallback offline).
        </li>
        <li>
          Estrutura inicial de p√°ginas criada: login, dashboard, uploads (lista/novo/detalhe),
          alertas, templates, contas, relat√≥rios e configura√ß√µes.
        </li>
        <li>
          Backend NestJS iniciado com m√≥dulos principais (auth, uploads, alertas, templates,
          contas, empresas), camada Prisma e integra√ß√£o com PostgreSQL/Redis via Docker Compose.
        </li>
        <li>
          <strong>Autentica√ß√£o JWT implementada:</strong> Login, guards, prote√ß√£o de rotas, interceptor Axios.
        </li>
        <li>
          <strong>Gest√£o de Empresas:</strong> CRUD completo de empresas com campo tipo (MATRIZ/FILIAL).
          Tabela Filial removida - simplifica√ß√£o da estrutura de dados.
        </li>
        <li>
          <strong>Upload de Arquivos:</strong> P√°gina de upload implementada com pr√©-visualiza√ß√£o,
          valida√ß√£o e sele√ß√£o de empresa/template. Falta processamento completo do Excel.
        </li>
        <li>
          Pr√≥ximos passos: implementar processamento completo de Excel (parsing, valida√ß√£o, alertas),
          sistema de alertas, templates din√¢micos, Web Push via VAPID e integra√ß√£o Groq.
        </li>
      </ul>
    </section>

    <section>
      <h2>Checklist - Integra√ß√£o Frontend ‚Üî Backend</h2>
      <ul>
        <li>[‚úì] Definir cliente HTTP global no frontend (axios/ky) com baseURL via vari√°veis de ambiente.</li>
        <li>[‚úì] Criar camadas de servi√ßo + React Query para consumir <code>/uploads</code>, <code>/alertas</code>, <code>/contas</code>, <code>/templates</code>, <code>/empresas</code>.</li>
        <li>[‚úì] Substituir dados mockados das p√°ginas por chamadas reais √†s APIs.</li>
        <li>[‚úì] Implementar autentica√ß√£o b√°sica (login) no backend e proteger endpoints.</li>
        <li>[‚úì] Conectar fluxo de login do frontend ao backend, armazenando token e protegendo rotas.</li>
        <li>[‚úì] Ajustar estados de carregamento/erro no frontend conforme respostas reais.</li>
        <li>[‚úì] Implementar CRUD completo de empresas (criar, editar, excluir, listar).</li>
        <li>[‚úì] Remover estrutura de filiais - simplifica√ß√£o para usar apenas empresas com tipo (MATRIZ/FILIAL).</li>
      </ul>
    </section>

    <section>
      <h2>Pr√≥ximos Passos de Implementa√ß√£o</h2>
      
      <h3>1. Autentica√ß√£o (‚úì Conclu√≠do)</h3>
      <ul>
        <li>[‚úì] Criar modelo <code>Usuario</code> no Prisma com campos: id, email, senha (hash), nome, roles, departamento, empresaId, createdAt, updatedAt.</li>
        <li>[‚úì] Implementar JWT no backend (Passport + JWT Strategy).</li>
        <li>[‚úì] Criar guards para proteger rotas (JwtAuthGuard).</li>
        <li>[‚úì] Implementar hash de senha com bcrypt.</li>
        <li>[‚úì] Conectar login do frontend ao backend.</li>
        <li>[‚úì] Armazenar token no localStorage via Zustand store.</li>
        <li>[‚úì] Proteger rotas no frontend (AuthGuard component).</li>
        <li>[‚úì] Adicionar interceptor no axios para incluir token nas requisi√ß√µes.</li>
        <li>[&nbsp;] Implementar refresh token (opcional - pendente).</li>
      </ul>

      <h3>1.1. Gest√£o de Empresas (‚úì Conclu√≠do)</h3>
      <ul>
        <li>[‚úì] Criar modelo <code>Empresa</code> no Prisma com campos: id, cnpj, razaoSocial, nomeFantasia, tipo (MATRIZ/FILIAL), createdAt, updatedAt.</li>
        <li>[‚úì] Implementar CRUD completo de empresas no backend (listar, criar, editar, excluir).</li>
        <li>[‚úì] Criar p√°gina <code>/empresas</code> no frontend com formul√°rios e listagem.</li>
        <li>[‚úì] Remover estrutura de filiais - simplifica√ß√£o usando apenas empresas com tipo.</li>
        <li>[‚úì] Atualizar Upload e ContaCatalogo para usar empresaId diretamente.</li>
        <li>[‚úì] Implementar valida√ß√£o de exclus√£o (verificar uploads, contas, templates, usu√°rios associados).</li>
      </ul>

      <h3>2. Upload de Arquivos Excel (üîÑ Parcialmente Conclu√≠do)</h3>
      <ul>
        <li>[‚úì] Criar p√°gina <code>/uploads/novo</code> com formul√°rio de upload.</li>
        <li>[‚úì] Implementar pr√©-visualiza√ß√£o com SheetJS (xlsx).</li>
        <li>[‚úì] Permitir sele√ß√£o de empresa e template de importa√ß√£o.</li>
        <li>[‚úì] Validar formato e tamanho do arquivo (frontend e backend).</li>
        <li>[‚úì] Salvar metadados do upload no banco (empresaId, mes, ano, hash).</li>
        <li>[‚úì] Implementar armazenamento local de arquivos (tempor√°rio - migrar para Supabase depois).</li>
        <li>[&nbsp;] Integrar com Supabase Storage para armazenar arquivos (pendente).</li>
        <li>[&nbsp;] Mostrar progresso do upload (pendente).</li>
        <li>[&nbsp;] Implementar processamento completo do arquivo Excel (pendente - ver pr√≥ximo passo).</li>
      </ul>

      <h3>3. Processamento de Excel (‚è≥ Pr√≥ximo Passo)</h3>
      <ul>
        <li>[&nbsp;] Criar worker/queue para processamento ass√≠ncrono (BullMQ).</li>
        <li>[&nbsp;] Implementar parser de planilhas Excel usando SheetJS no backend.</li>
        <li>[&nbsp;] Mapear colunas conforme template de importa√ß√£o.</li>
        <li>[&nbsp;] Validar e converter dados (n√∫meros, datas, textos).</li>
        <li>[&nbsp;] Criar registros em <code>LinhaUpload</code>.</li>
        <li>[&nbsp;] Calcular hash de cada linha para detec√ß√£o de mudan√ßas.</li>
        <li>[&nbsp;] Atualizar status do upload (PROCESSANDO ‚Üí CONCLUIDO/COM_ALERTAS).</li>
        <li>[&nbsp;] Atualizar cat√°logo de contas (<code>ContaCatalogo</code>).</li>
      </ul>

      <h3>4. Sistema de Alertas</h3>
      <ul>
        <li>Detectar diverg√™ncias de saldo (saldo anterior + d√©bito - cr√©dito ‚â† saldo atual).</li>
        <li>Identificar contas novas comparando com cat√°logo existente.</li>
        <li>Detectar dados inconsistentes (valores nulos, formatos inv√°lidos).</li>
        <li>Criar registros de alerta no banco.</li>
        <li>Implementar workflow de resolu√ß√£o de alertas.</li>
        <li>Adicionar filtros e busca na p√°gina de alertas.</li>
        <li>Permitir marcar alertas como resolvidos/em an√°lise.</li>
      </ul>

      <h3>5. Funcionalidades Avan√ßadas</h3>
      <ul>
        <li><strong>Offline Storage:</strong> Implementar IndexedDB com Dexie para armazenar dados localmente.</li>
        <li><strong>Push Notifications:</strong> Configurar Web Push via VAPID pr√≥prio.</li>
        <li><strong>Integra√ß√£o Groq AI:</strong> Criar servi√ßo para an√°lises e insights dos dados.</li>
        <li><strong>Dashboard:</strong> Implementar KPIs, gr√°ficos e m√©tricas.</li>
        <li><strong>Edi√ß√£o de Linhas:</strong> Permitir editar/remover linhas de upload.</li>
        <li><strong>Hist√≥rico de Auditoria:</strong> Registrar todas as a√ß√µes no sistema.</li>
        <li><strong>Relat√≥rios:</strong> Gerar relat√≥rios comparativos e an√°lises.</li>
      </ul>
    </section>

    <section>
      <h2>Vis√£o Geral</h2>
      <ul>
        <li>PWA instal√°vel com opera√ß√£o offline e sincroniza√ß√£o quando online.</li>
        <li>
          Importa√ß√£o de planilhas Excel configur√°vel (usu√°rio define mapeamentos
          e campos din√¢micos).
        </li>
        <li>
          Detec√ß√£o autom√°tica de diverg√™ncias de saldo, novas contas e altera√ß√µes
          em rela√ß√£o a importa√ß√µes anteriores.
        </li>
        <li>Push notifications e e-mails (Resend) para alertas e atualiza√ß√µes.</li>
        <li>
          Integra√ß√£o com Groq (modelos de baixo custo) para an√°lises assistidas.
        </li>
      </ul>
    </section>

    <section>
      <h2>Arquitetura &amp; Infraestrutura</h2>
      <h3>Frontend</h3>
      <ul>
        <li><span class="tag">Framework</span>Next.js (React + TypeScript)</li>
        <li><span class="tag">Estado</span>@tanstack/query, Zustand</li>
        <li><span class="tag">Formul√°rios</span>React Hook Form + Zod</li>
        <li><span class="tag">UI</span>Tailwind CSS (ou outra biblioteca utilit√°ria)</li>
        <li><span class="tag">PWA</span>next-pwa, Workbox, IndexedDB via Dexie</li>
        <li><span class="tag">Excel</span>SheetJS (xlsx) para parsing e preview</li>
      </ul>

      <h3>Backend</h3>
      <ul>
        <li><span class="tag">Framework</span>NestJS (Node.js + TypeScript)</li>
        <li><span class="tag">Banco</span>PostgreSQL com Prisma ORM</li>
        <li><span class="tag">Fila</span>BullMQ + Redis para processamento ass√≠ncrono</li>
        <li><span class="tag">Storage</span>Supabase Storage para arquivos brutos</li>
        <li><span class="tag">Notifica√ß√µes</span>Resend (e-mail) e Firebase/OneSignal (push)</li>
        <li><span class="tag">IA</span>Cliente HTTP para Groq API</li>
      </ul>

      <h3>DevOps &amp; Hospedagem</h3>
      <ul>
        <li><span class="tag">Frontend</span>Vercel (com dom√≠nio pr√≥prio)</li>
        <li><span class="tag">Backend</span>Container Docker (Render/Fly.io ou VPS)</li>
        <li><span class="tag">Banco de Dados</span>PostgreSQL gerenciado (Supabase, Railway, Neon, ou VPS)</li>
        <li><span class="tag">CI/CD</span>GitHub Actions (lint, test, build, deploy)</li>
        <li><span class="tag">Monitoramento</span>Sentry, logs estruturados com Pino</li>
      </ul>
    </section>

    <section>
      <h2>Op√ß√µes de Hospedagem para Produ√ß√£o</h2>
      
      <h3>Op√ß√£o 1: Solu√ß√£o Completa Gerenciada (Recomendada para come√ßar)</h3>
      <ul>
        <li><strong>Frontend:</strong> Vercel (gratuito at√© certo limite, dom√≠nio pr√≥prio suportado)</li>
        <li><strong>Backend:</strong> Render.com ou Fly.io (containers Docker, dom√≠nio pr√≥prio)</li>
        <li><strong>PostgreSQL:</strong> Supabase (gratuito at√© 500MB), Railway, Neon, ou Render PostgreSQL</li>
        <li><strong>Redis:</strong> Upstash (gratuito at√© 10k comandos/dia) ou Redis Cloud</li>
        <li><strong>Storage:</strong> Supabase Storage (j√° inclu√≠do no plano)</li>
        <li><strong>Vantagens:</strong> F√°cil setup, escal√°vel, backups autom√°ticos</li>
        <li><strong>Custo estimado:</strong> $0-20/m√™s (in√≠cio) at√© $50-100/m√™s (crescimento)</li>
      </ul>

      <h3>Op√ß√£o 2: VPS (Virtual Private Server) - M√°ximo controle</h3>
      <ul>
        <li><strong>Provedores:</strong> DigitalOcean, Linode, Vultr, AWS Lightsail, Contabo</li>
        <li><strong>Setup:</strong> Docker Compose com PostgreSQL, Redis, Backend tudo no mesmo servidor</li>
        <li><strong>Dom√≠nio:</strong> Configurar DNS apontando para IP do VPS</li>
        <li><strong>Frontend:</strong> Pode hospedar no VPS tamb√©m ou usar Vercel</li>
        <li><strong>Vantagens:</strong> Controle total, custo fixo, sem limites de uso</li>
        <li><strong>Desvantagens:</strong> Precisa gerenciar backups, seguran√ßa, updates manualmente</li>
        <li><strong>Custo estimado:</strong> $5-20/m√™s (VPS b√°sico) + dom√≠nio ($10-15/ano)</li>
      </ul>

      <h3>Op√ß√£o 3: H√≠brida (Recomendada para produ√ß√£o)</h3>
      <ul>
        <li><strong>Frontend:</strong> Vercel (otimizado para Next.js, CDN global)</li>
        <li><strong>Backend:</strong> Render.com ou Railway (auto-deploy do GitHub)</li>
        <li><strong>PostgreSQL:</strong> Supabase, Neon ou Railway PostgreSQL (managed)</li>
        <li><strong>Redis:</strong> Upstash (serverless Redis)</li>
        <li><strong>Storage:</strong> Supabase Storage</li>
        <li><strong>Dom√≠nio:</strong> Configurar em cada servi√ßo (Vercel, Render, etc.)</li>
        <li><strong>Vantagens:</strong> Melhor performance, escalabilidade autom√°tica, backups gerenciados</li>
        <li><strong>Custo estimado:</strong> $0-30/m√™s (in√≠cio) at√© $100-200/m√™s (crescimento)</li>
      </ul>

      <h3>Migra√ß√£o do Banco Local para Produ√ß√£o</h3>
      <ol>
        <li><strong>Exportar dados locais:</strong> <code>pg_dump</code> ou Prisma Studio</li>
        <li><strong>Criar banco em produ√ß√£o:</strong> Supabase/Railway/Neon</li>
        <li><strong>Executar migrations:</strong> <code>npx prisma migrate deploy</code></li>
        <li><strong>Importar dados:</strong> <code>psql</code> ou ferramenta de importa√ß√£o</li>
        <li><strong>Atualizar DATABASE_URL:</strong> Vari√°vel de ambiente no servi√ßo de hospedagem</li>
      </ol>

      <h3>Checklist de Deploy</h3>
      <ul>
        <li>[ ] Configurar vari√°veis de ambiente em produ√ß√£o (DATABASE_URL, JWT_SECRET, etc.)</li>
        <li>[ ] Configurar dom√≠nio pr√≥prio (DNS, SSL/HTTPS autom√°tico na maioria das plataformas)</li>
        <li>[ ] Configurar GitHub Actions para deploy autom√°tico</li>
        <li>[ ] Configurar backups autom√°ticos do banco de dados</li>
        <li>[ ] Configurar monitoramento (Sentry, logs)</li>
        <li>[ ] Testar autentica√ß√£o e todas as rotas em produ√ß√£o</li>
        <li>[ ] Configurar CORS para aceitar apenas o dom√≠nio de produ√ß√£o</li>
        <li>[ ] Configurar rate limiting no backend</li>
      </ul>
    </section>

    <section>
      <h2>Modelo de Dados Implementado</h2>
      <ul>
        <li><strong>empresa</strong>: id, cnpj, razaoSocial, nomeFantasia, tipo (MATRIZ/FILIAL), createdAt, updatedAt.</li>
        <li><strong>usuario</strong>: id, email, senha (hash), nome, roles, departamento, empresaId, createdAt, updatedAt.</li>
        <li>
          <strong>template_importacao</strong>: id, empresaId, nome, descricao, configuracao (JSON), createdAt, updatedAt.
        </li>
        <li>
          <strong>upload</strong>: id, empresaId, templateId, mes, ano, arquivoUrl, hashArquivo, status, totalLinhas, createdBy, createdAt, updatedAt.
        </li>
        <li>
          <strong>linha_upload</strong>: id, uploadId, classificacao, conta, subConta, nomeConta, tipoConta, nivel, titulo, estabelecimento, saldoAnterior, debito, credito, saldoAtual, hashLinha, createdAt.
        </li>
        <li>
          <strong>conta_catalogo</strong>: id, empresaId, classificacao, nomeConta, tipoConta, nivel, primeiraImportacao, ultimaImportacao, status.
        </li>
        <li>
          <strong>alerta</strong>: id, uploadId, linhaId, tipo, severidade, mensagem, status, createdAt, resolvedAt.
        </li>
        <li>
          <strong>log_auditoria</strong>: id, usuarioId, recurso, acao, dados (JSON), createdAt.
        </li>
      </ul>
      <p><strong>Nota:</strong> A estrutura de filiais foi removida e simplificada. Agora usamos apenas empresas com campo tipo (MATRIZ/FILIAL) para indicar se √© matriz ou filial.</p>
    </section>

    <section>
      <h2>Fluxo de Importa√ß√£o</h2>
      <ol>
        <li>
          Usu√°rio faz upload do Excel ‚Üí pr√©-visualiza√ß√£o com SheetJS e sele√ß√£o
          de template.
        </li>
        <li>
          Arquivo √© enviado ao backend, armazenado localmente (tempor√°rio - migrar para Supabase Storage) e
          registrado em <code>upload</code> com empresaId, mes, ano e hash do arquivo.
        </li>
        <li>
          <strong>[Pendente]</strong> Worker processa linhas: converte valores, calcula hash, valida saldo
          (<code>saldo anterior + d√©bito - cr√©dito</code> vs. <code>saldo atual</code>).
        </li>
        <li>
          <strong>[Pendente]</strong> Identifica contas novas ou altera√ß√µes em rela√ß√£o ao cat√°logo existente.
        </li>
        <li>
          <strong>[Pendente]</strong> Gera alertas, atualiza status e dispara notifica√ß√µes (push/e-mail).
        </li>
        <li>
          Usu√°rio acessa detalhes do upload, pode editar/remover linhas, marcar
          alertas como resolvidos ou reprocessar.
        </li>
      </ol>
    </section>

    <section>
      <h2>P√°ginas Principais (Next.js)</h2>
      <ul>
        <li><strong>/login</strong>: autentica√ß√£o e aviso de modo offline.</li>
        <li>
          <strong>/dashboard</strong>: KPIs, √∫ltimos uploads, alertas recentes.
        </li>
        <li>
          <strong>/uploads</strong>: listagem, filtros, a√ß√µes de download,
          reprocesso e exclus√£o.
        </li>
        <li>
          <strong>/uploads/novo</strong>: wizard de importa√ß√£o com preview.
        </li>
        <li>
          <strong>/uploads/&lt;id&gt;</strong>: detalhes, diffs, edi√ß√£o de linhas.
        </li>
        <li>
          <strong>/alertas</strong>: painel dedicado aos alertas e workflow.
        </li>
        <li>
          <strong>/templates</strong>: CRUD de templates de importa√ß√£o.
        </li>
        <li>
          <strong>/contas</strong>: cat√°logo consolidado e gest√£o de novas contas.
        </li>
        <li>
          <strong>/relatorios</strong>: an√°lises Groq e hist√≥rico de consultas.
        </li>
        <li>
          <strong>/empresas</strong>: CRUD completo de empresas (criar, editar, excluir, listar).
        </li>
        <li>
          <strong>/configuracoes</strong>: links para empresas, templates, usu√°rios,
          integra√ß√µes, prefer√™ncias de notifica√ß√£o.
        </li>
      </ul>
    </section>

    <section>
      <h2>Depend√™ncias Principais</h2>
      <h3>Frontend (Next.js)</h3>
      <ul>
        <li>next, react, react-dom, typescript</li>
        <li>@tanstack/react-query, zustand, react-hook-form, zod</li>
        <li>tailwindcss, @headlessui/react (ou biblioteca de UI preferida)</li>
        <li>xlsx (SheetJS), dexie, axios</li>
        <li>next-pwa, workbox-window</li>
        <li>firebase/app e firebase/messaging ou onesignal</li>
        <li>dayjs/date-fns, intl para formatos num√©ricos brasileiros</li>
        <li>vitest/jest, @testing-library/react, cypress</li>
      </ul>

      <h3>Backend (NestJS)</h3>
      <ul>
        <li>@nestjs/core, @nestjs/common, @nestjs/config</li>
        <li>prisma, @prisma/client, class-validator, class-transformer</li>
        <li>@nestjs/passport, passport-jwt, bcrypt</li>
        <li>@supabase/supabase-js, multer</li>
        <li>bullmq, @nestjs/bull, ioredis</li>
        <li>xlsx/csv-parse para parsing adicional</li>
        <li>resend, firebase-admin ou onesignal-node</li>
        <li>axios (Groq), pino/@nestjs/pino, sentry</li>
        <li>jest, supertest</li>
      </ul>

      <h3>Ferramentas DevOps</h3>
      <ul>
        <li>GitHub Actions para pipelines de lint, test e deploy.</li>
        <li>Docker, docker-compose (PostgreSQL + Redis + backend).</li>
        <li>eslint, prettier, lint-staged, husky, commitlint.</li>
      </ul>
    </section>

    <section>
      <h2>Backlog Priorit√°rio</h2>
      <ol>
        <li>Configurar reposit√≥rio GitHub com monorepo (frontend + backend).</li>
        <li>Bootstrap Next.js (PWA) e NestJS com Prisma conectando ao PostgreSQL.</li>
        <li>Implementar CRUD de templates e fluxo de upload com pr√©-visualiza√ß√£o.</li>
        <li>Criar pipeline de processamento e gera√ß√£o de alertas (saldo, contas novas).</li>
        <li>Adicionar notifica√ß√µes (push + e-mail) e hist√≥rico de auditoria.</li>
        <li>Integrar Groq para an√°lises de relat√≥rios e insights.</li>
        <li>Entrega de dashboards e recursos avan√ßados (comparativos, diffs, edi√ß√£o).</li>
      </ol>
    </section>

    <footer>
      <p>
        √öltima atualiza√ß√£o:
        <time datetime="2025-11-13">13 de novembro de 2025</time>. Documento
        atualizado com progresso recente: autentica√ß√£o conclu√≠da, gest√£o de empresas implementada,
        estrutura de filiais removida e simplificada.
      </p>
    </footer>
  </body>
</html>

