<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Plano de Implementação - Resultado Econômico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 960px;
        line-height: 1.6;
        color: #1a202c;
      }
      h1,
      h2,
      h3 {
        color: #2c5282;
      }
      code {
        font-family: Consolas, Monaco, "Courier New", monospace;
        background-color: #f1f5f9;
        padding: 0 0.25rem;
        border-radius: 4px;
      }
      ul {
        padding-left: 1.25rem;
      }
      header,
      section {
        margin-bottom: 2.5rem;
      }
      .tag {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        margin-right: 0.5rem;
        border-radius: 999px;
        background-color: #bee3f8;
        color: #2b6cb0;
        font-size: 0.85rem;
      }
      .status {
        font-weight: bold;
        color: #2f855a;
      }
      footer {
        font-size: 0.85rem;
        color: #4a5568;
        border-top: 1px solid #e2e8f0;
        padding-top: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Plano de Implementação - Sistema de Resultado Econômico</h1>
      <p>
        Documento de referência para o desenvolvimento do sistema de resultado
        econômico com base no arquivo
        <code>Balancete Consolidado 2025.xls</code>. Status atual:
        <span class="status">Processamento completo de Excel implementado - Sistema de alertas funcional incluindo validação de continuidade temporal - Relatório DRE completo com filtros avançados e autocomplete - Melhorias de UX/UI e configuração para rede local</span>.
      </p>
    </header>

    <section>
      <h2>Andamento do Projeto</h2>
      <ul>
        <li>Repositório Git inicializado, conectado ao GitHub e documentado.</li>
        <li>
          Frontend Next.js configurado (TypeScript, Tailwind, React Query, Zustand) com
          suporte PWA completo (manifesto, service worker, ícones e fallback offline).
        </li>
        <li>
          Estrutura inicial de páginas criada: login, dashboard, uploads (lista/novo/detalhe),
          alertas, templates, contas, relatórios e configurações.
        </li>
        <li>
          Backend NestJS iniciado com módulos principais (auth, uploads, alertas, templates,
          contas, empresas), camada Prisma e integração com PostgreSQL/Redis via Docker Compose.
        </li>
        <li>
          <strong>Autenticação JWT implementada:</strong> Login, guards, proteção de rotas, interceptor Axios.
        </li>
        <li>
          <strong>Gestão de Empresas:</strong> CRUD completo de empresas com campo tipo (MATRIZ/FILIAL).
          Tabela Filial removida - simplificação da estrutura de dados.
        </li>
        <li>
          <strong>Upload de Arquivos:</strong> Página de upload implementada com pré-visualização inteligente,
          validação client-side, detecção automática de cabeçalho, indicadores visuais para colunas extras,
          e seleção de empresa/template. Processamento completo de Excel implementado com tratamento de colunas extras.
        </li>
        <li>
          <strong>Processamento de Excel:</strong> Parser completo implementado com detecção automática de cabeçalhos,
          conversão de formatos brasileiros (números com vírgula), validação de dados, criação de LinhaUpload,
          atualização de catálogo de contas unificado e geração de alertas.
        </li>
        <li>
          <strong>Catálogo de Contas Unificado:</strong> Catálogo único para todas as empresas (sem duplicatas por empresa).
          Cada classificação de conta aparece apenas uma vez no sistema, independente da empresa que a importou.
        </li>
        <li>
          <strong>Templates de Importação:</strong> CRUD completo implementado com suporte a templates globais
          (disponíveis para todas as empresas) e templates específicos por empresa.
        </li>
        <li>
          <strong>Sistema de Alertas:</strong> Detecção automática de saldos divergentes (fórmula corrigida),
          contas novas, dados inconsistentes (incluindo células vazias) e alterações no cabeçalho do Excel
          com diferenciação entre colunas ausentes (crítico) e colunas extras (informativo).
        </li>
        <li>
          <strong>Relatório DRE:</strong> Implementado relatório completo de Resultado Econômico com filtros por ano, tipo (Filial/Consolidado), empresas e descrição (autocomplete). Exibição hierárquica de contas com expandir/colapsar e checkbox para expandir todos os níveis.
        </li>
        <li>
          <strong>Melhorias no Sistema de Alertas:</strong> Filtro e contagem por tipoConta, correção de mensagens com terminologia adequada (Classificação, Conta, SubConta), e armazenamento do nome original do arquivo.
        </li>
        <li>
          <strong>Melhorias de UX/UI:</strong> Correção de sobreposição de elementos, ajuste de layout dos filtros, login mais compacto, linha inteira da tabela de uploads clicável, e correção de autenticação (não redireciona mais ao recarregar página).
        </li>
        <li>
          <strong>Configuração para Rede Local:</strong> Sistema configurado para ser acessível de outros computadores na mesma rede (0.0.0.0, CORS ajustado).
        </li>
        <li>
          Próximos passos: implementar exportação Excel/PDF do relatório, Web Push via VAPID, integração Groq e dashboard com KPIs.
        </li>
      </ul>
    </section>

    <section>
      <h2>Checklist - Integração Frontend ↔ Backend</h2>
      <ul>
        <li>[✓] Definir cliente HTTP global no frontend (axios/ky) com baseURL via variáveis de ambiente.</li>
        <li>[✓] Criar camadas de serviço + React Query para consumir <code>/uploads</code>, <code>/alertas</code>, <code>/contas</code>, <code>/templates</code>, <code>/empresas</code>.</li>
        <li>[✓] Substituir dados mockados das páginas por chamadas reais às APIs.</li>
        <li>[✓] Implementar autenticação básica (login) no backend e proteger endpoints.</li>
        <li>[✓] Conectar fluxo de login do frontend ao backend, armazenando token e protegendo rotas.</li>
        <li>[✓] Ajustar estados de carregamento/erro no frontend conforme respostas reais.</li>
        <li>[✓] Implementar CRUD completo de empresas (criar, editar, excluir, listar).</li>
        <li>[✓] Remover estrutura de filiais - simplificação para usar apenas empresas com tipo (MATRIZ/FILIAL).</li>
        <li>[✓] Corrigir erros de lint no frontend e backend (tipos TypeScript, variáveis não utilizadas, etc.).</li>
      </ul>
    </section>

    <section>
      <h2>Próximos Passos de Implementação</h2>
      
      <h3>1. Autenticação (✓ Concluído)</h3>
      <ul>
        <li>[✓] Criar modelo <code>Usuario</code> no Prisma com campos: id, email, senha (hash), nome, roles, departamento, empresaId, createdAt, updatedAt.</li>
        <li>[✓] Implementar JWT no backend (Passport + JWT Strategy).</li>
        <li>[✓] Criar guards para proteger rotas (JwtAuthGuard).</li>
        <li>[✓] Implementar hash de senha com bcrypt.</li>
        <li>[✓] Conectar login do frontend ao backend.</li>
        <li>[✓] Armazenar token no localStorage via Zustand store.</li>
        <li>[✓] Proteger rotas no frontend (AuthGuard component).</li>
        <li>[✓] Adicionar interceptor no axios para incluir token nas requisições.</li>
        <li>[&nbsp;] Implementar refresh token (opcional - pendente).</li>
      </ul>

      <h3>1.1. Gestão de Empresas (✓ Concluído)</h3>
      <ul>
        <li>[✓] Criar modelo <code>Empresa</code> no Prisma com campos: id, cnpj, razaoSocial, nomeFantasia, tipo (MATRIZ/FILIAL), createdAt, updatedAt.</li>
        <li>[✓] Implementar CRUD completo de empresas no backend (listar, criar, editar, excluir).</li>
        <li>[✓] Criar página <code>/empresas</code> no frontend com formulários e listagem.</li>
        <li>[✓] Remover estrutura de filiais - simplificação usando apenas empresas com tipo.</li>
        <li>[✓] Atualizar Upload para usar empresaId diretamente.</li>
        <li>[✓] Unificar catálogo de contas - remover empresaId de ContaCatalogo (cada classificação aparece apenas uma vez).</li>
        <li>[✓] Implementar validação de exclusão (verificar uploads, contas, templates, usuários associados).</li>
      </ul>

      <h3>2. Upload de Arquivos Excel (✓ Concluído)</h3>
      <ul>
        <li>[✓] Criar página <code>/uploads/novo</code> com formulário de upload.</li>
        <li>[✓] Implementar pré-visualização com SheetJS (xlsx).</li>
        <li>[✓] Permitir seleção de empresa e template de importação (incluindo templates globais).</li>
        <li>[✓] Validar formato e tamanho do arquivo (frontend e backend).</li>
        <li>[✓] Salvar metadados do upload no banco (empresaId, mes, ano, hash).</li>
        <li>[✓] Implementar armazenamento local de arquivos (temporário - migrar para Supabase depois).</li>
        <li>[✓] Corrigir rolagem horizontal da tabela de pré-visualização (scroll contido no DIV).</li>
        <li>[✓] Implementar detecção inteligente de cabeçalho na pré-visualização (busca por palavras-chave de balancete).</li>
        <li>[✓] Corrigir desalinhamento de dados na pré-visualização (normalização de colunas baseada no cabeçalho detectado).</li>
        <li>[✓] Adicionar indicadores visuais para colunas extras (Mês, UF) que serão ignoradas no processamento.</li>
        <li>[✓] Implementar validação client-side com detecção de colunas extras e alertas informativos.</li>
        <li>[✓] Melhorar mensagens de alerta no backend para diferenciar colunas ausentes vs. colunas extras.</li>
        <li>[✓] Implementar funcionalidade de remover upload com modal de confirmação e exclusão em cascata.</li>
        <li>[✓] Melhorar layout da página de uploads com informações completas da empresa (Razão Social, Nome Fantasia, CNPJ).</li>
        <li>[&nbsp;] Integrar com Supabase Storage para armazenar arquivos (pendente).</li>
        <li>[✓] Atualização automática de status (polling a cada 5s quando há uploads processando).</li>
        <li>[✓] Mostrar progresso detalhado do upload (barra de progresso, porcentagem) - <strong>CONCLUÍDO</strong> - endpoint disponível para consulta de progresso em tempo real.</li>
        <li>[✓] Implementar processamento completo do arquivo Excel (ver próximo passo).</li>
      </ul>

      <h3>3. Processamento de Excel (✓ Concluído)</h3>
      <ul>
        <li>[✓] Criar worker/queue para processamento assíncrono (BullMQ) - <strong>CONCLUÍDO</strong> - melhora performance e evita timeouts em arquivos grandes. Processamento agora é feito em background com retry automático.</li>
        <li>[✓] Implementar atualização automática (polling) na página de uploads quando houver uploads em processamento.</li>
        <li>[✓] Implementar parser de planilhas Excel usando SheetJS no backend.</li>
        <li>[✓] Detecção automática de linha de cabeçalho (busca por primeira linha com texto não-numérico).</li>
        <li>[✓] Mapear colunas conforme template de importação ou auto-detecção por palavras-chave.</li>
        <li>[✓] Validar e converter dados (números brasileiros com vírgula, booleanos, textos).</li>
        <li>[✓] Tratamento de células vazias (convertidas para null).</li>
        <li>[✓] Criar registros em <code>LinhaUpload</code> em lotes para melhor performance.</li>
        <li>[✓] Calcular hash de cada linha para detecção de mudanças.</li>
        <li>[✓] Atualizar status do upload (PROCESSANDO → CONCLUIDO/COM_ALERTAS).</li>
        <li>[✓] Atualizar catálogo de contas unificado (<code>ContaCatalogo</code>) automaticamente - sem duplicatas por empresa.</li>
        <li>[✓] Logging extensivo para debugging do processo de parsing.</li>
        <li>[✓] Barra de progresso detalhada do upload - <strong>CONCLUÍDO</strong> - endpoint <code>GET /uploads/:id/progresso</code> retorna porcentagem e status por etapa (lendo arquivo, processando linhas, criando registros, atualizando catálogo, detectando alertas, finalizando).</li>
      </ul>

      <h3>3.1. Validação de Continuidade Temporal (✓ Concluído)</h3>
      <ul>
        <li>[✓] Implementar validação que compara saldo atual do mês anterior com saldo anterior do mês atual.</li>
        <li>[✓] Usar chave composta (classificação + conta + subConta) para garantir comparação precisa de linhas.</li>
        <li>[✓] Tratar casos especiais (Janeiro → Dezembro do ano anterior).</li>
        <li>[✓] Selecionar automaticamente o upload mais completo quando há múltiplos uploads do mesmo mês.</li>
        <li>[✓] Gerar alerta do tipo <code>CONTINUIDADE_TEMPORAL_DIVERGENTE</code> quando detectar diferenças.</li>
        <li>[✓] Definir severidade baseada na diferença: BAIXA (>0.01), MÉDIA (>1000), ALTA (>10000).</li>
        <li>[✓] Incluir logs detalhados para debug e investigação de problemas.</li>
        <li>[✓] Adicionar novo tipo de alerta no enum <code>AlertaTipo</code> do Prisma.</li>
        <li>[✓] Criar migration para adicionar novo valor ao enum no banco de dados.</li>
      </ul>

      <h3>3.2. Templates de Importação (✓ Concluído)</h3>
      <ul>
        <li>[✓] Criar modelo <code>TemplateImportacao</code> no Prisma com campo <code>empresaId</code> opcional.</li>
        <li>[✓] Implementar CRUD completo de templates no backend.</li>
        <li>[✓] Suporte a templates globais (empresaId = null) disponíveis para todas as empresas.</li>
        <li>[✓] Suporte a templates específicos por empresa (empresaId definido).</li>
        <li>[✓] Criar página <code>/templates</code> no frontend com formulários e listagem.</li>
        <li>[✓] Atualizar página de upload para filtrar templates globais e da empresa selecionada.</li>
        <li>[✓] Interface visual para identificar templates globais vs. específicos.</li>
      </ul>

      <h3>4. Sistema de Alertas (✓ Concluído)</h3>
      <ul>
        <li>[✓] Detectar divergências de saldo (saldo anterior + débito + crédito ≠ saldo atual) com tolerância de 0.01 (fórmula corrigida - crédito já vem com sinal do Excel).</li>
        <li>[✓] Identificar contas novas comparando com catálogo existente.</li>
        <li>[✓] Detectar dados inconsistentes (valores nulos, formatos inválidos, campos obrigatórios ausentes).</li>
        <li>[✓] Detectar células vazias em campos importantes (Classificação, Conta, Nome da Conta, valores numéricos).</li>
        <li>[✓] Detectar alterações no cabeçalho do Excel (colunas ausentes, colunas novas, mudanças no número de colunas).</li>
        <li>[✓] Diferenciação entre colunas ausentes (severidade ALTA) e colunas extras conhecidas (Mês, UF - severidade BAIXA, informativo).</li>
        <li>[✓] Mensagens claras informando que colunas extras serão ignoradas no processamento.</li>
        <li>[✓] Criar registros de alerta no banco com tipos: SALDO_DIVERGENTE, CONTA_NOVA, DADO_INCONSISTENTE, CABECALHO_ALTERADO, CONTINUIDADE_TEMPORAL_DIVERGENTE.</li>
        <li>[✓] Classificar alertas por severidade (BAIXA, MEDIA, ALTA) baseado no impacto.</li>
        <li>[✓] Mensagens descritivas para cada tipo de alerta.</li>
        <li>[✓] Implementar workflow de resolução de alertas (concluído).</li>
        <li>[✓] Adicionar filtros e busca na página de alertas (concluído).</li>
        <li>[✓] Permitir marcar alertas como resolvidos/em análise (concluído).</li>
      </ul>

      <h3>5. Relatórios de Resultado Econômico (✓ Concluído)</h3>
      <ul>
        <li>[✓] Implementar geração de relatório DRE (Demonstrativo de Resultado Econômico) com hierarquia de contas.</li>
        <li>[✓] Suporte a relatórios por Filial ou Consolidado.</li>
        <li>[✓] Filtros por ano, tipo de relatório, empresas (múltipla seleção para consolidado).</li>
        <li>[✓] Busca dinâmica de anos disponíveis no banco de dados.</li>
        <li>[✓] Exibição hierárquica de contas com expandir/colapsar por nível.</li>
        <li>[✓] <strong>Filtro por descrição com autocomplete:</strong> Campo de busca que sugere descrições disponíveis no banco de dados conforme o usuário digita (mínimo 2 caracteres, debounce de 300ms).</li>
        <li>[✓] <strong>Checkbox "Expandir Níveis":</strong> Permite expandir ou colapsar toda a hierarquia de contas com um único clique.</li>
        <li>[✓] Valores formatados em moeda brasileira (R$) com separadores de milhar e 2 decimais.</li>
        <li>[✓] Tabela responsiva com colunas fixas (CLASSI, DESCRI, Total) e scroll horizontal para meses.</li>
        <li>[✓] Exibição de UF junto ao nome da empresa no cabeçalho do relatório.</li>
        <li>[&nbsp;] Exportação para Excel e PDF (pendente - botões desabilitados).</li>
      </ul>

      <h3>5.1. Sistema de Alertas - Melhorias (✓ Concluído)</h3>
      <ul>
        <li>[✓] <strong>Filtro e contagem por tipoConta:</strong> Permite filtrar alertas por tipo de conta (ex: "1-Ativo", "2-Passivo") com contadores clicáveis.</li>
        <li>[✓] Exibição do tipoConta em cada alerta na tabela (clicável para filtrar).</li>
        <li>[✓] Seção de contadores por tipoConta mostrando total de alertas de cada tipo.</li>
        <li>[✓] Contagem de alertas por tipoConta na página de detalhes do upload.</li>
        <li>[✓] <strong>Correção de mensagens de alerta:</strong> Mensagens agora usam terminologia correta (Classificação, Conta, SubConta) em vez de apenas "conta" seguido da classificação. Identificação completa: "A conta 'Nome da Conta' identificada por Classificação: X | Conta: Y | SubConta: Z".</li>
        <li>[✓] Campo <code>nomeArquivo</code> adicionado ao modelo Upload para armazenar o nome original do arquivo enviado.</li>
        <li>[✓] Exibição do nome do arquivo na listagem de uploads e na página de detalhes.</li>
      </ul>

      <h3>5.2. Melhorias de UX/UI (✓ Concluído)</h3>
      <ul>
        <li>[✓] Remoção do elemento "Usuário Demo" do header do sistema.</li>
        <li>[✓] Correção de sobreposição de elementos na página de relatórios (header, tabela sticky).</li>
        <li>[✓] Ajuste de layout dos filtros para alinhar todos os elementos ao topo.</li>
        <li>[✓] Login page mais compacto para evitar scroll desnecessário.</li>
        <li>[✓] Atualização do email de contato no login.</li>
        <li>[✓] Linha inteira da tabela de uploads é clicável (removida coluna "Ações").</li>
        <li>[✓] <strong>Correção de autenticação:</strong> Sistema não redireciona mais para login ao recarregar página (F5). Implementada hidratação correta do estado de autenticação no Zustand com flag <code>_hasHydrated</code>.</li>
      </ul>

      <h3>5.3. Configuração para Rede Local (✓ Concluído)</h3>
      <ul>
        <li>[✓] Frontend configurado para escutar em <code>0.0.0.0</code> permitindo acesso de outros computadores na rede.</li>
        <li>[✓] Backend configurado para escutar em <code>0.0.0.0</code> permitindo conexões externas.</li>
        <li>[✓] CORS ajustado para aceitar IPs da rede local (10.1.x.x).</li>
        <li>[✓] Arquivo <code>.env.local</code> criado com configuração de API para rede local.</li>
        <li>[✓] Documentação de como acessar o sistema de outros computadores na mesma rede.</li>
      </ul>

      <h3>6. Funcionalidades Avançadas</h3>
      <ul>
        <li><strong>Histórico de Auditoria:</strong> Registrar todas as ações no sistema - <strong>CONCLUÍDO</strong> - log de alterações em uploads, alertas e empresas para rastreabilidade e segurança. Serviço <code>AuditoriaService</code> integrado em todos os módulos principais.</li>
        <li><strong>Offline Storage:</strong> Implementar IndexedDB com Dexie para armazenar dados localmente (pendente).</li>
        <li><strong>Push Notifications:</strong> Configurar Web Push via VAPID próprio (pendente).</li>
        <li><strong>Integração Groq AI:</strong> Criar serviço para análises e insights dos dados (pendente).</li>
        <li><strong>Dashboard:</strong> Implementar KPIs, gráficos e métricas (pendente).</li>
        <li><strong>Edição de Linhas:</strong> Permitir editar/remover linhas de upload (pendente).</li>
        <li><strong>Relatórios Comparativos:</strong> Gerar relatórios comparativos e análises (pendente).</li>
      </ul>
    </section>

    <section>
      <h2>Visão Geral</h2>
      <ul>
        <li>PWA instalável com operação offline e sincronização quando online.</li>
        <li>
          Importação de planilhas Excel configurável (usuário define mapeamentos
          e campos dinâmicos).
        </li>
        <li>
          Detecção automática de divergências de saldo (fórmula: saldo anterior + débito + crédito),
          novas contas, dados inconsistentes, células vazias e alterações no cabeçalho do Excel
          com tratamento inteligente de colunas extras (Mês, UF) que são ignoradas no processamento.
        </li>
        <li>
          Catálogo de contas unificado - cada classificação aparece apenas uma vez, independente da empresa.
        </li>
        <li>
          Templates de importação globais (disponíveis para todas as empresas) ou específicos por empresa.
        </li>
        <li>
          Atualização automática de status de uploads em processamento (polling inteligente).
        </li>
        <li>
          <strong>Relatório DRE completo:</strong> Geração de relatório de Resultado Econômico com filtros avançados (ano, tipo, empresas, descrição com autocomplete), exibição hierárquica de contas e checkbox para expandir todos os níveis.
        </li>
        <li>
          <strong>Sistema de alertas aprimorado:</strong> Filtro e contagem por tipoConta, mensagens mais precisas com terminologia adequada, e armazenamento do nome original do arquivo.
        </li>
        <li>
          <strong>Acesso em rede local:</strong> Sistema configurado para ser acessível de outros computadores na mesma rede.
        </li>
        <li>Push notifications e e-mails (Resend) para alertas e atualizações (pendente).</li>
        <li>
          Integração com Groq (modelos de baixo custo) para análises assistidas (pendente).
        </li>
      </ul>
    </section>

    <section>
      <h2>Arquitetura &amp; Infraestrutura</h2>
      <h3>Frontend</h3>
      <ul>
        <li><span class="tag">Framework</span>Next.js (React + TypeScript)</li>
        <li><span class="tag">Estado</span>@tanstack/query, Zustand</li>
        <li><span class="tag">Formulários</span>React Hook Form + Zod</li>
        <li><span class="tag">UI</span>Tailwind CSS (ou outra biblioteca utilitária)</li>
        <li><span class="tag">PWA</span>next-pwa, Workbox, IndexedDB via Dexie</li>
        <li><span class="tag">Excel</span>SheetJS (xlsx) para parsing e preview</li>
      </ul>

      <h3>Backend</h3>
      <ul>
        <li><span class="tag">Framework</span>NestJS (Node.js + TypeScript)</li>
        <li><span class="tag">Banco</span>PostgreSQL com Prisma ORM</li>
        <li><span class="tag">Fila</span>BullMQ + Redis para processamento assíncrono</li>
        <li><span class="tag">Storage</span>Supabase Storage para arquivos brutos</li>
        <li><span class="tag">Notificações</span>Resend (e-mail) e Firebase/OneSignal (push)</li>
        <li><span class="tag">IA</span>Cliente HTTP para Groq API</li>
      </ul>

      <h3>DevOps &amp; Hospedagem</h3>
      <ul>
        <li><span class="tag">Frontend</span>Vercel (com domínio próprio)</li>
        <li><span class="tag">Backend</span>Container Docker (Render/Fly.io ou VPS)</li>
        <li><span class="tag">Banco de Dados</span>PostgreSQL gerenciado (Supabase, Railway, Neon, ou VPS)</li>
        <li><span class="tag">CI/CD</span>GitHub Actions (lint, test, build, deploy)</li>
        <li><span class="tag">Monitoramento</span>Sentry, logs estruturados com Pino</li>
      </ul>
    </section>

    <section>
      <h2>Opções de Hospedagem para Produção</h2>
      
      <h3>Opção 1: Solução Completa Gerenciada (Recomendada para começar)</h3>
      <ul>
        <li><strong>Frontend:</strong> Vercel (gratuito até certo limite, domínio próprio suportado)</li>
        <li><strong>Backend:</strong> Render.com ou Fly.io (containers Docker, domínio próprio)</li>
        <li><strong>PostgreSQL:</strong> Supabase (gratuito até 500MB), Railway, Neon, ou Render PostgreSQL</li>
        <li><strong>Redis:</strong> Upstash (gratuito até 10k comandos/dia) ou Redis Cloud</li>
        <li><strong>Storage:</strong> Supabase Storage (já incluído no plano)</li>
        <li><strong>Vantagens:</strong> Fácil setup, escalável, backups automáticos</li>
        <li><strong>Custo estimado:</strong> $0-20/mês (início) até $50-100/mês (crescimento)</li>
      </ul>

      <h3>Opção 2: VPS (Virtual Private Server) - Máximo controle</h3>
      <ul>
        <li><strong>Provedores:</strong> DigitalOcean, Linode, Vultr, AWS Lightsail, Contabo</li>
        <li><strong>Setup:</strong> Docker Compose com PostgreSQL, Redis, Backend tudo no mesmo servidor</li>
        <li><strong>Domínio:</strong> Configurar DNS apontando para IP do VPS</li>
        <li><strong>Frontend:</strong> Pode hospedar no VPS também ou usar Vercel</li>
        <li><strong>Vantagens:</strong> Controle total, custo fixo, sem limites de uso</li>
        <li><strong>Desvantagens:</strong> Precisa gerenciar backups, segurança, updates manualmente</li>
        <li><strong>Custo estimado:</strong> $5-20/mês (VPS básico) + domínio ($10-15/ano)</li>
      </ul>

      <h3>Opção 3: Híbrida (Recomendada para produção)</h3>
      <ul>
        <li><strong>Frontend:</strong> Vercel (otimizado para Next.js, CDN global)</li>
        <li><strong>Backend:</strong> Render.com ou Railway (auto-deploy do GitHub)</li>
        <li><strong>PostgreSQL:</strong> Supabase, Neon ou Railway PostgreSQL (managed)</li>
        <li><strong>Redis:</strong> Upstash (serverless Redis)</li>
        <li><strong>Storage:</strong> Supabase Storage</li>
        <li><strong>Domínio:</strong> Configurar em cada serviço (Vercel, Render, etc.)</li>
        <li><strong>Vantagens:</strong> Melhor performance, escalabilidade automática, backups gerenciados</li>
        <li><strong>Custo estimado:</strong> $0-30/mês (início) até $100-200/mês (crescimento)</li>
      </ul>

      <h3>Migração do Banco Local para Produção</h3>
      <ol>
        <li><strong>Exportar dados locais:</strong> <code>pg_dump</code> ou Prisma Studio</li>
        <li><strong>Criar banco em produção:</strong> Supabase/Railway/Neon</li>
        <li><strong>Executar migrations:</strong> <code>npx prisma migrate deploy</code></li>
        <li><strong>Importar dados:</strong> <code>psql</code> ou ferramenta de importação</li>
        <li><strong>Atualizar DATABASE_URL:</strong> Variável de ambiente no serviço de hospedagem</li>
      </ol>

      <h3>Checklist de Deploy</h3>
      <ul>
        <li>[ ] Configurar variáveis de ambiente em produção (DATABASE_URL, JWT_SECRET, etc.)</li>
        <li>[ ] Configurar domínio próprio (DNS, SSL/HTTPS automático na maioria das plataformas)</li>
        <li>[ ] Configurar GitHub Actions para deploy automático</li>
        <li>[ ] Configurar backups automáticos do banco de dados</li>
        <li>[ ] Configurar monitoramento (Sentry, logs)</li>
        <li>[ ] Testar autenticação e todas as rotas em produção</li>
        <li>[ ] Configurar CORS para aceitar apenas o domínio de produção</li>
        <li>[ ] Configurar rate limiting no backend</li>
      </ul>
    </section>

    <section>
      <h2>Modelo de Dados Implementado</h2>
      <ul>
        <li><strong>empresa</strong>: id, cnpj, razaoSocial, nomeFantasia, tipo (MATRIZ/FILIAL), createdAt, updatedAt.</li>
        <li><strong>usuario</strong>: id, email, senha (hash), nome, roles, departamento, empresaId, createdAt, updatedAt.</li>
        <li>
          <strong>template_importacao</strong>: id, empresaId (opcional - null = template global), nome, descricao, configuracao (JSON), createdAt, updatedAt.
        </li>
        <li>
          <strong>linha_upload</strong>: id, uploadId, classificacao, conta, subConta, nomeConta, tipoConta, nivel, titulo, estabelecimento, saldoAnterior, debito, credito, saldoAtual, hashLinha, createdAt.
        </li>
        <li>
          <strong>conta_catalogo</strong>: id, classificacao (única), nomeConta, tipoConta, nivel, primeiraImportacao, ultimaImportacao, status. <strong>Catálogo unificado - sem empresaId.</strong>
        </li>
        <li>
          <strong>alerta</strong>: id, uploadId, linhaId, tipo (SALDO_DIVERGENTE, CONTA_NOVA, DADO_INCONSISTENTE, CABECALHO_ALTERADO, CONTINUIDADE_TEMPORAL_DIVERGENTE), severidade (BAIXA, MEDIA, ALTA), mensagem, status, createdAt, resolvedAt.
        </li>
        <li>
          <strong>upload</strong>: id, empresaId, templateId, mes, ano, arquivoUrl, <strong>nomeArquivo</strong> (nome original do arquivo), hashArquivo, status, totalLinhas, createdBy, createdAt, updatedAt.
        </li>
        <li>
          <strong>log_auditoria</strong>: id, usuarioId, recurso, acao, dados (JSON), createdAt.
        </li>
      </ul>
      <p><strong>Nota:</strong> A estrutura de filiais foi removida e simplificada. Agora usamos apenas empresas com campo tipo (MATRIZ/FILIAL) para indicar se é matriz ou filial.</p>
    </section>

    <section>
      <h2>Fluxo de Importação</h2>
      <ol>
        <li>
          Usuário faz upload do Excel → pré-visualização inteligente com SheetJS:
          <ul>
            <li>Detecção automática do cabeçalho (busca por palavras-chave de balancete).</li>
            <li>Normalização de colunas para garantir alinhamento correto dos dados.</li>
            <li>Indicadores visuais para colunas extras (Mês, UF) que serão ignoradas.</li>
            <li>Validação client-side com alertas informativos sobre colunas extras.</li>
            <li>Seleção de empresa e template (global ou específico da empresa).</li>
          </ul>
        </li>
        <li>
          Arquivo é enviado ao backend, armazenado localmente (temporário - migrar para Supabase Storage) e
          registrado em <code>upload</code> com empresaId, templateId (opcional), mes, ano e hash do arquivo.
          Status inicial: PROCESSANDO.
        </li>
        <li>
          <strong>[Implementado]</strong> Backend processa o arquivo Excel:
          <ul>
            <li>Detecta automaticamente a linha de cabeçalho (busca primeira linha com texto não-numérico).</li>
            <li>Mapeia colunas usando template configurado ou auto-detecção por palavras-chave.</li>
            <li>Ignora colunas extras não mapeadas (ex: Mês, UF) - apenas colunas mapeadas são processadas.</li>
            <li>Converte valores (números brasileiros com vírgula, booleanos, textos).</li>
            <li>Trata células vazias (converte para null).</li>
            <li>Cria registros em <code>LinhaUpload</code> em lotes.</li>
            <li>Calcula hash de cada linha para detecção de mudanças.</li>
            <li>Atualiza catálogo de contas unificado (<code>ContaCatalogo</code> - sem empresaId, classificacao única).</li>
          </ul>
        </li>
        <li>
          <strong>[Implementado]</strong> Sistema de detecção de alertas:
          <ul>
            <li>Valida saldo (<code>saldo anterior + débito + crédito</code> vs. <code>saldo atual</code>) com tolerância de 0.01 (fórmula corrigida para considerar crédito já com sinal).</li>
            <li>Identifica contas novas comparando com catálogo existente.</li>
            <li>Detecta dados inconsistentes (campos obrigatórios ausentes, células vazias em campos importantes).</li>
            <li>Detecta alterações no cabeçalho (colunas ausentes, colunas novas, mudanças no número de colunas).</li>
            <li>Diferencia colunas ausentes (crítico) de colunas extras conhecidas (Mês, UF - informativo).</li>
            <li><strong>[Implementado] Validação de Continuidade Temporal:</strong> Compara o saldo atual do mês anterior com o saldo anterior do mês atual para detectar alterações retroativas feitas pela contabilidade sem avisar. Usa chave composta (classificação + conta + subConta) para garantir comparação precisa. Gera alerta do tipo <code>CONTINUIDADE_TEMPORAL_DIVERGENTE</code> com severidade baseada na diferença (BAIXA: >0.01, MÉDIA: >1000, ALTA: >10000). Trata casos especiais (Janeiro → Dezembro do ano anterior). Seleciona automaticamente o upload mais completo quando há múltiplos uploads do mesmo mês.</li>
            <li>Cria alertas com severidade apropriada (BAIXA, MEDIA, ALTA).</li>
          </ul>
        </li>
        <li>
          <strong>[Implementado]</strong> Atualiza status do upload:
          <ul>
            <li>Se houver alertas: status = COM_ALERTAS</li>
            <li>Se não houver alertas: status = CONCLUIDO</li>
          </ul>
        </li>
        <li>
          <strong>[Pendente]</strong> Disparar notificações (push/e-mail) quando houver alertas.
        </li>
        <li>
          Usuário acessa detalhes do upload, pode visualizar alertas, editar/remover linhas,
          marcar alertas como resolvidos ou reprocessar.
        </li>
      </ol>
    </section>

    <section>
      <h2>Páginas Principais (Next.js)</h2>
      <ul>
        <li><strong>/login</strong>: autenticação e aviso de modo offline.</li>
        <li>
          <strong>/dashboard</strong>: KPIs, últimos uploads, alertas recentes.
        </li>
        <li>
          <strong>/uploads</strong>: listagem, filtros, ações de download,
          reprocesso e exclusão.
        </li>
        <li>
          <strong>/uploads/novo</strong>: wizard de importação com preview.
        </li>
        <li>
          <strong>/uploads/&lt;id&gt;</strong>: detalhes, diffs, edição de linhas.
        </li>
        <li>
          <strong>/alertas</strong>: painel dedicado aos alertas e workflow.
        </li>
        <li>
          <strong>/templates</strong>: CRUD de templates de importação.
        </li>
        <li>
          <strong>/contas</strong>: catálogo consolidado e gestão de novas contas.
        </li>
        <li>
          <strong>/relatorios</strong>: análises Groq e histórico de consultas.
        </li>
        <li>
          <strong>/relatorios/resultado</strong>: Relatório DRE (Demonstrativo de Resultado Econômico) com filtros por ano, tipo (Filial/Consolidado), empresas e descrição. Exibição hierárquica de contas com expandir/colapsar e checkbox para expandir todos os níveis.
        </li>
        <li>
          <strong>/empresas</strong>: CRUD completo de empresas (criar, editar, excluir, listar).
        </li>
        <li>
          <strong>/configuracoes</strong>: links para empresas, templates, usuários,
          integrações, preferências de notificação.
        </li>
      </ul>
    </section>

    <section>
      <h2>Dependências Principais</h2>
      <h3>Frontend (Next.js)</h3>
      <ul>
        <li>next, react, react-dom, typescript</li>
        <li>@tanstack/react-query, zustand, react-hook-form, zod</li>
        <li>tailwindcss, @headlessui/react (ou biblioteca de UI preferida)</li>
        <li>xlsx (SheetJS), dexie, axios</li>
        <li>next-pwa, workbox-window</li>
        <li>firebase/app e firebase/messaging ou onesignal</li>
        <li>dayjs/date-fns, intl para formatos numéricos brasileiros</li>
        <li>vitest/jest, @testing-library/react, cypress</li>
      </ul>

      <h3>Backend (NestJS)</h3>
      <ul>
        <li>@nestjs/core, @nestjs/common, @nestjs/config</li>
        <li>prisma, @prisma/client, class-validator, class-transformer</li>
        <li>@nestjs/passport, passport-jwt, bcrypt</li>
        <li>@supabase/supabase-js, multer</li>
        <li>bullmq, @nestjs/bull, ioredis</li>
        <li>xlsx/csv-parse para parsing adicional</li>
        <li>resend, firebase-admin ou onesignal-node</li>
        <li>axios (Groq), pino/@nestjs/pino, sentry</li>
        <li>jest, supertest</li>
      </ul>

      <h3>Ferramentas DevOps</h3>
      <ul>
        <li>GitHub Actions para pipelines de lint, test e deploy.</li>
        <li>Docker, docker-compose (PostgreSQL + Redis + backend).</li>
        <li>eslint, prettier, lint-staged, husky, commitlint.</li>
      </ul>
    </section>

    <section>
      <h2>Backlog Prioritário</h2>
      <ol>
        <li>Configurar repositório GitHub com monorepo (frontend + backend).</li>
        <li>Bootstrap Next.js (PWA) e NestJS com Prisma conectando ao PostgreSQL.</li>
        <li>Implementar CRUD de templates e fluxo de upload com pré-visualização.</li>
        <li>Criar pipeline de processamento e geração de alertas (saldo, contas novas).</li>
        <li>Adicionar notificações (push + e-mail) e histórico de auditoria.</li>
        <li>Integrar Groq para análises de relatórios e insights.</li>
        <li>Entrega de dashboards e recursos avançados (comparativos, diffs, edição).</li>
      </ol>
    </section>

    <footer>
      <p>
        Última atualização:
        <time datetime="2025-11-17">17 de novembro de 2025</time>. Documento
        atualizado com progresso recente: processamento completo de Excel implementado,
        sistema de alertas funcional (incluindo detecção de alterações no cabeçalho com diferenciação
        entre colunas ausentes e extras), templates globais disponíveis, detecção de células vazias,
        melhorias no parsing de números brasileiros, correção do desalinhamento na pré-visualização
        com detecção inteligente de cabeçalho, indicadores visuais para colunas extras, validação
        client-side, funcionalidade de remover upload com exclusão em cascata, unificação do catálogo
        de contas (sem duplicatas por empresa), atualização automática de status de uploads em processamento,
        <strong>processamento assíncrono com BullMQ e Redis</strong> (melhora performance e evita timeouts),
        <strong>barra de progresso detalhada do upload</strong> com endpoint para consulta em tempo real,
        <strong>histórico de auditoria completo</strong> registrando todas as ações do sistema (uploads, alertas, empresas),
        <strong>validação de continuidade temporal</strong> que detecta alterações retroativas comparando saldos entre meses consecutivos usando chave composta (classificação + conta + subConta) para garantir precisão na comparação,
        <strong>relatório DRE completo</strong> com filtros por descrição (autocomplete), expandir/colapsar níveis, e exibição hierárquica de contas,
        <strong>melhorias no sistema de alertas</strong> com filtro e contagem por tipoConta, correção de mensagens com terminologia adequada, e armazenamento do nome original do arquivo,
        <strong>correção de autenticação</strong> para não redirecionar ao recarregar página (F5), e
        <strong>configuração para rede local</strong> permitindo acesso de outros computadores na mesma rede.
      </p>
    </footer>
  </body>
</html>

