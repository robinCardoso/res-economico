generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Empresa {
  id                    String               @id @default(uuid())
  cnpj                  String               @unique
  razaoSocial           String
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  nomeFantasia          String?
  tipo                  TipoEmpresa          @default(MATRIZ)
  uf                    String?
  setor                 String?
  porte                 PorteEmpresa?
  dataFundacao          DateTime?
  descricao             String?
  website               String?
  modeloNegocio         ModeloNegocio?
  modeloNegocioDetalhes Json?
  contasReceita         Json?
  custosCentralizados   Boolean?
  contasCustos          Json?
  receitasCentralizadas Boolean?
  resumos               ResumoEconomico[]
  templates             TemplateImportacao[]
  uploads               Upload[]
  usuarios              Usuario[]
  processos             Processo[]
}

model ConfiguracaoModeloNegocio {
  id                    String        @id @default(uuid())
  modeloNegocio         ModeloNegocio @unique
  modeloNegocioDetalhes Json
  contasReceita         Json
  contasCustos          Json
  custosCentralizados   Boolean
  descricao             String?
  ativo                 Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  receitasCentralizadas Boolean       @default(false)
}

model Usuario {
  id           String            @id @default(uuid())
  email        String            @unique
  senha        String
  nome         String
  roles        String[]          @default(["user"])
  empresaId    String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  departamento Departamento?
  logs         LogAuditoria[]
  resumos      ResumoEconomico[]
  processos    Processo[]
  empresa      Empresa?          @relation(fields: [empresaId], references: [id])
}

model TemplateImportacao {
  id           String   @id @default(uuid())
  empresaId    String?
  nome         String
  descricao    String?
  configuracao Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  empresa      Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  uploads      Upload[]
}

model Upload {
  id          String              @id @default(uuid())
  templateId  String?
  mes         Int
  ano         Int
  arquivoUrl  String
  hashArquivo String
  status      UploadStatus        @default(PROCESSANDO)
  totalLinhas Int
  createdBy   String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  empresaId   String
  nomeArquivo String
  alertas     Alerta[]
  linhas      LinhaUpload[]
  resumos     ResumoEconomico[]
  empresa     Empresa             @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  template    TemplateImportacao? @relation(fields: [templateId], references: [id])

  @@index([status, ano])
  @@index([ano, mes])
  @@index([empresaId, ano, mes])
  @@index([status, empresaId, ano])
}

model LinhaUpload {
  id              String   @id @default(uuid())
  uploadId        String
  classificacao   String
  conta           String
  subConta        String?
  nomeConta       String
  tipoConta       String
  nivel           Int
  titulo          Boolean
  estabelecimento Boolean
  saldoAnterior   Decimal  @db.Decimal(18, 2)
  debito          Decimal  @db.Decimal(18, 2)
  credito         Decimal  @db.Decimal(18, 2)
  saldoAtual      Decimal  @db.Decimal(18, 2)
  hashLinha       String
  createdAt       DateTime @default(now())
  alertas         Alerta[]
  upload          Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
}

model ContaCatalogo {
  id                 String      @id @default(uuid())
  classificacao      String
  conta              String
  tipoConta          String
  nivel              Int
  primeiraImportacao DateTime    @default(now())
  ultimaImportacao   DateTime    @default(now())
  status             ContaStatus @default(ATIVA)
  subConta           String      @default("")
  nomeConta          String

  @@unique([classificacao, conta, subConta])
}

model Alerta {
  id         String           @id @default(uuid())
  uploadId   String
  linhaId    String?
  tipo       AlertaTipo
  severidade AlertaSeveridade
  mensagem   String
  status     AlertaStatus     @default(ABERTO)
  createdAt  DateTime         @default(now())
  resolvedAt DateTime?
  linha      LinhaUpload?     @relation(fields: [linhaId], references: [id])
  upload     Upload           @relation(fields: [uploadId], references: [id], onDelete: Cascade)
}

model LogAuditoria {
  id        String   @id @default(uuid())
  recurso   String
  acao      String
  usuarioId String
  dados     Json
  createdAt DateTime @default(now())
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model ResumoEconomico {
  id          String       @id @default(uuid())
  titulo      String
  periodo     String
  mes         Int?
  ano         Int
  empresaId   String?
  uploadId    String?
  tipoAnalise String
  parametros  Json
  resultado   Json
  modeloIA    String
  status      ResumoStatus @default(PROCESSANDO)
  criadoPor   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  criador     Usuario      @relation(fields: [criadoPor], references: [id], onDelete: Cascade)
  empresa     Empresa?     @relation(fields: [empresaId], references: [id])
  upload      Upload?      @relation(fields: [uploadId], references: [id])

  @@index([empresaId, ano, mes])
  @@index([criadoPor, createdAt])
  @@index([status])
}

enum TipoEmpresa {
  MATRIZ
  FILIAL
}

enum PorteEmpresa {
  MICRO
  PEQUENA
  MEDIA
  GRANDE
}

enum ModeloNegocio {
  ASSOCIACAO
  COMERCIO
  INDUSTRIA
  SERVICOS
  AGROPECUARIA
  OUTRO
}

enum ResumoStatus {
  PROCESSANDO
  CONCLUIDO
  ERRO
  CANCELADO
}

enum UploadStatus {
  PROCESSANDO
  CONCLUIDO
  COM_ALERTAS
  CANCELADO
}

enum AlertaTipo {
  SALDO_DIVERGENTE
  CONTA_NOVA
  DADO_INCONSISTENTE
  CABECALHO_ALTERADO
  CONTINUIDADE_TEMPORAL_DIVERGENTE
}

enum AlertaSeveridade {
  BAIXA
  MEDIA
  ALTA
}

enum AlertaStatus {
  ABERTO
  EM_ANALISE
  RESOLVIDO
}

enum ContaStatus {
  ATIVA
  NOVA
  ARQUIVADA
}

enum Departamento {
  FINANCEIRO
  COMPRAS
  GESTOR
  FATURAMENTO
}

// =====================================================
// MODELOS DE PROCESSOS
// =====================================================

model Processo {
  id                    String            @id @default(uuid())
  numeroControle        String            @unique
  protocolo             String            @unique
  userId                String
  empresaId             String?
  
  // Dados básicos
  tipo                  TipoProcesso
  situacao              SituacaoProcesso  @default(AGUARDANDO_ANALISE)
  nomeClienteAssociado  String
  razaoSocial           String
  titulo                String?
  descricao             String?
  categoria             CategoriaReclamacao?
  prioridade            PrioridadeProcesso?
  contatoRetorno        String?
  
  // Localização
  uf                    String?
  cidade                String?
  
  // Dados específicos
  fabrica               String?
  importacao            String?
  ano                   String?
  reclamacao            String?
  
  // Responsável e prazos
  responsavel           String?
  prazoResolucao        DateTime?
  dataSolucao           DateTime?
  comentarios           String?
  
  // Relacionamentos
  usuario               Usuario           @relation(fields: [userId], references: [id], onDelete: Cascade)
  empresa               Empresa?          @relation(fields: [empresaId], references: [id])
  itens                 ProcessoItem[]
  anexos                ProcessoAnexo[]
  historico             ProcessoHistorico[]
  
  // Metadados
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@index([userId, createdAt])
  @@index([empresaId, createdAt])
  @@index([tipo, situacao])
  @@index([situacao, createdAt])
  @@index([numeroControle])
  @@index([protocolo])
}

model ProcessoItem {
  id                    String            @id @default(uuid())
  processoId            String
  nf                    String
  referencia            String
  descricaoProduto      String?
  qtd                   Int
  valorUnit             Decimal            @db.Decimal(18, 2)
  detalhes              String
  marca                 String?
  
  // Informações técnicas (para garantias)
  dataInstalacao        DateTime?
  dataRemocao           DateTime?
  kmInstalacao          String?
  kmRemocao             String?
  modeloVeiculo         String?
  anoVeiculo            String?
  marcaVeiculo          String?
  
  // Custo de garantia
  temCustoGarantia      Boolean           @default(false)
  valorCusto            Decimal?          @db.Decimal(18, 2)
  infoPecas              String?
  
  // Relacionamentos
  processo              Processo          @relation(fields: [processoId], references: [id], onDelete: Cascade)
  
  // Metadados
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@index([processoId])
}

model ProcessoAnexo {
  id                    String            @id @default(uuid())
  processoId            String
  nomeArquivo           String
  urlArquivo            String
  tipoArquivo           TipoArquivoProcesso
  tamanhoArquivo        Int?
  mimeType              String?
  uploadedBy            String?
  metadata              Json?
  
  // Relacionamentos
  processo              Processo          @relation(fields: [processoId], references: [id], onDelete: Cascade)
  
  // Metadados
  uploadedAt            DateTime          @default(now())
  
  @@index([processoId])
}

model ProcessoHistorico {
  id                    String            @id @default(uuid())
  processoId            String
  acao                  String
  descricao             String
  usuarioId             String?
  usuarioNome           String?
  dadosAnteriores       Json?
  dadosNovos            Json?
  metadata              Json?
  
  // Relacionamentos
  processo              Processo          @relation(fields: [processoId], references: [id], onDelete: Cascade)
  
  // Metadados
  createdAt             DateTime          @default(now())
  
  @@index([processoId, createdAt])
  @@index([usuarioId])
}

// Enums para Processos
enum TipoProcesso {
  GARANTIA
  DEVOLUCAO
  RECLAMACAO
}

enum SituacaoProcesso {
  AGUARDANDO_ANALISE
  EM_ANALISE
  APROVADO
  REJEITADO
  EM_PROCESSAMENTO
  CONCLUIDO
  CANCELADO
}

enum CategoriaReclamacao {
  ATENDIMENTO
  PRODUTOS
  LOGISTICA
  FINANCEIRO
  TECNICO
  COMUNICACAO
}

enum PrioridadeProcesso {
  BAIXA
  MEDIA
  ALTA
}

enum TipoArquivoProcesso {
  IMAGEM
  VIDEO
  DOCUMENTO
  NOTA_FISCAL
  PROTOCOLO_FABRICA
}
