generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Empresa {
  id                    String               @id @default(uuid())
  cnpj                  String               @unique
  razaoSocial           String
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  nomeFantasia          String?
  tipo                  TipoEmpresa          @default(MATRIZ)
  uf                    String?
  setor                 String?
  porte                 PorteEmpresa?
  dataFundacao          DateTime?
  descricao             String?
  website               String?
  modeloNegocio         ModeloNegocio?
  modeloNegocioDetalhes Json?
  contasReceita         Json?
  custosCentralizados   Boolean?
  contasCustos          Json?
  receitasCentralizadas Boolean?
  resumos               ResumoEconomico[]
  templates             TemplateImportacao[]
  uploads               Upload[]
  usuarios              Usuario[]
  processos             Processo[]
  atas                  AtaReuniao[]
  modelosAtas           ModeloAta[]
}

model ConfiguracaoModeloNegocio {
  id                    String        @id @default(uuid())
  modeloNegocio         ModeloNegocio @unique
  modeloNegocioDetalhes Json
  contasReceita         Json
  contasCustos          Json
  custosCentralizados   Boolean
  descricao             String?
  ativo                 Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  receitasCentralizadas Boolean       @default(false)
}

model Usuario {
  id                     String                  @id @default(uuid())
  email                  String                  @unique
  senha                  String
  nome                   String
  roles                  String[]                @default(["user"])
  empresaId              String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  departamento           Departamento?
  logs                   LogAuditoria[]
  resumos                ResumoEconomico[]
  processos              Processo[]
  atas                   AtaReuniao[]
  participantesAtas      AtaParticipante[]
  comentariosAtas        AtaComentario[]
  modelosAtas            ModeloAta[]
  historicoAtas          HistoricoAndamento[]
  prazosAtas             PrazoAcao[]
  lembretesPrazos        LembretePrazo[]
  preferenciaNotificacao PreferenciaNotificacao?
  pushSubscriptions      PushSubscription[]
  logsAlteracoesAtas     LogAlteracaoAta[]
  empresa                Empresa?                @relation(fields: [empresaId], references: [id])
}

model TemplateImportacao {
  id           String   @id @default(uuid())
  empresaId    String?
  nome         String
  descricao    String?
  configuracao Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  empresa      Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  uploads      Upload[]
}

model Upload {
  id          String              @id @default(uuid())
  templateId  String?
  mes         Int
  ano         Int
  arquivoUrl  String
  hashArquivo String
  status      UploadStatus        @default(PROCESSANDO)
  totalLinhas Int
  createdBy   String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  empresaId   String
  nomeArquivo String
  alertas     Alerta[]
  linhas      LinhaUpload[]
  resumos     ResumoEconomico[]
  empresa     Empresa             @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  template    TemplateImportacao? @relation(fields: [templateId], references: [id])

  @@index([status, ano])
  @@index([ano, mes])
  @@index([empresaId, ano, mes])
  @@index([status, empresaId, ano])
}

model LinhaUpload {
  id              String   @id @default(uuid())
  uploadId        String
  classificacao   String
  conta           String
  subConta        String?
  nomeConta       String
  tipoConta       String
  nivel           Int
  titulo          Boolean
  estabelecimento Boolean
  saldoAnterior   Decimal  @db.Decimal(18, 2)
  debito          Decimal  @db.Decimal(18, 2)
  credito         Decimal  @db.Decimal(18, 2)
  saldoAtual      Decimal  @db.Decimal(18, 2)
  hashLinha       String
  createdAt       DateTime @default(now())
  alertas         Alerta[]
  upload          Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)
}

model ContaCatalogo {
  id                 String      @id @default(uuid())
  classificacao      String
  conta              String
  tipoConta          String
  nivel              Int
  primeiraImportacao DateTime    @default(now())
  ultimaImportacao   DateTime    @default(now())
  status             ContaStatus @default(ATIVA)
  subConta           String      @default("")
  nomeConta          String

  @@unique([classificacao, conta, subConta])
}

model Alerta {
  id         String           @id @default(uuid())
  uploadId   String
  linhaId    String?
  tipo       AlertaTipo
  severidade AlertaSeveridade
  mensagem   String
  status     AlertaStatus     @default(ABERTO)
  createdAt  DateTime         @default(now())
  resolvedAt DateTime?
  linha      LinhaUpload?     @relation(fields: [linhaId], references: [id])
  upload     Upload           @relation(fields: [uploadId], references: [id], onDelete: Cascade)
}

model LogAuditoria {
  id        String   @id @default(uuid())
  recurso   String
  acao      String
  usuarioId String
  dados     Json
  createdAt DateTime @default(now())
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model ResumoEconomico {
  id          String       @id @default(uuid())
  titulo      String
  periodo     String
  mes         Int?
  ano         Int
  empresaId   String?
  uploadId    String?
  tipoAnalise String
  parametros  Json
  resultado   Json
  modeloIA    String
  status      ResumoStatus @default(PROCESSANDO)
  criadoPor   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  criador     Usuario      @relation(fields: [criadoPor], references: [id], onDelete: Cascade)
  empresa     Empresa?     @relation(fields: [empresaId], references: [id])
  upload      Upload?      @relation(fields: [uploadId], references: [id])

  @@index([empresaId, ano, mes])
  @@index([criadoPor, createdAt])
  @@index([status])
}

enum TipoEmpresa {
  MATRIZ
  FILIAL
}

enum PorteEmpresa {
  MICRO
  PEQUENA
  MEDIA
  GRANDE
}

enum ModeloNegocio {
  ASSOCIACAO
  COMERCIO
  INDUSTRIA
  SERVICOS
  AGROPECUARIA
  OUTRO
}

enum ResumoStatus {
  PROCESSANDO
  CONCLUIDO
  ERRO
  CANCELADO
}

enum UploadStatus {
  PROCESSANDO
  CONCLUIDO
  COM_ALERTAS
  CANCELADO
}

enum AlertaTipo {
  SALDO_DIVERGENTE
  CONTA_NOVA
  DADO_INCONSISTENTE
  CABECALHO_ALTERADO
  CONTINUIDADE_TEMPORAL_DIVERGENTE
}

enum AlertaSeveridade {
  BAIXA
  MEDIA
  ALTA
}

enum AlertaStatus {
  ABERTO
  EM_ANALISE
  RESOLVIDO
}

enum ContaStatus {
  ATIVA
  NOVA
  ARQUIVADA
}

enum Departamento {
  FINANCEIRO
  COMPRAS
  GESTOR
  FATURAMENTO
}

// =====================================================
// MODELOS DE PROCESSOS
// =====================================================

model Processo {
  id             String  @id @default(uuid())
  numeroControle String  @unique
  protocolo      String  @unique
  userId         String
  empresaId      String?

  // Dados básicos
  tipo                 TipoProcesso
  situacao             SituacaoProcesso     @default(AGUARDANDO_ANALISE)
  nomeClienteAssociado String
  razaoSocial          String
  titulo               String?
  descricao            String?
  categoria            CategoriaReclamacao?
  prioridade           PrioridadeProcesso?
  contatoRetorno       String?

  // Localização
  uf     String?
  cidade String?

  // Dados específicos
  fabrica    String?
  importacao String?
  ano        String?
  reclamacao String?

  // Responsável e prazos
  responsavel    String?
  prazoResolucao DateTime?
  dataSolucao    DateTime?
  comentarios    String?

  // Relacionamentos
  usuario   Usuario             @relation(fields: [userId], references: [id], onDelete: Cascade)
  empresa   Empresa?            @relation(fields: [empresaId], references: [id])
  itens     ProcessoItem[]
  anexos    ProcessoAnexo[]
  historico ProcessoHistorico[]

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([empresaId, createdAt])
  @@index([tipo, situacao])
  @@index([situacao, createdAt])
  @@index([numeroControle])
  @@index([protocolo])
}

model ProcessoItem {
  id               String  @id @default(uuid())
  processoId       String
  nf               String
  referencia       String
  descricaoProduto String?
  qtd              Int
  valorUnit        Decimal @db.Decimal(18, 2)
  detalhes         String
  marca            String?

  // Informações técnicas (para garantias)
  dataInstalacao DateTime?
  dataRemocao    DateTime?
  kmInstalacao   String?
  kmRemocao      String?
  modeloVeiculo  String?
  anoVeiculo     String?
  marcaVeiculo   String?

  // Custo de garantia
  temCustoGarantia Boolean  @default(false)
  valorCusto       Decimal? @db.Decimal(18, 2)
  infoPecas        String?

  // Relacionamentos
  processo Processo @relation(fields: [processoId], references: [id], onDelete: Cascade)

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([processoId])
}

model ProcessoAnexo {
  id             String              @id @default(uuid())
  processoId     String
  nomeArquivo    String
  urlArquivo     String
  tipoArquivo    TipoArquivoProcesso
  tamanhoArquivo Int?
  mimeType       String?
  uploadedBy     String?
  metadata       Json?

  // Relacionamentos
  processo Processo @relation(fields: [processoId], references: [id], onDelete: Cascade)

  // Metadados
  uploadedAt DateTime @default(now())

  @@index([processoId])
}

model ProcessoHistorico {
  id              String  @id @default(uuid())
  processoId      String
  acao            String
  descricao       String
  usuarioId       String?
  usuarioNome     String?
  dadosAnteriores Json?
  dadosNovos      Json?
  metadata        Json?

  // Relacionamentos
  processo Processo @relation(fields: [processoId], references: [id], onDelete: Cascade)

  // Metadados
  createdAt DateTime @default(now())

  @@index([processoId, createdAt])
  @@index([usuarioId])
}

// Enums para Processos
enum TipoProcesso {
  GARANTIA
  DEVOLUCAO
  RECLAMACAO
}

enum SituacaoProcesso {
  AGUARDANDO_ANALISE
  EM_ANALISE
  APROVADO
  REJEITADO
  EM_PROCESSAMENTO
  CONCLUIDO
  CANCELADO
}

enum CategoriaReclamacao {
  ATENDIMENTO
  PRODUTOS
  LOGISTICA
  FINANCEIRO
  TECNICO
  COMUNICACAO
}

enum PrioridadeProcesso {
  BAIXA
  MEDIA
  ALTA
}

enum TipoArquivoProcesso {
  IMAGEM
  VIDEO
  DOCUMENTO
  NOTA_FISCAL
  PROTOCOLO_FABRICA
}

// =====================================================
// MODELOS DE ATAS E REUNIÕES
// =====================================================

model AtaReuniao {
  id          String      @id @default(uuid())
  numero      String      @unique
  titulo      String
  tipo        TipoReuniao
  dataReuniao DateTime
  local       String?
  status      StatusAta   @default(RASCUNHO)

  // Conteúdo
  pauta       String? // Pauta da reunião (texto simples - legado)
  conteudo    String? // Conteúdo/resumo da reunião
  descricao   String? // Descrição breve da ata
  resumo      String? // Resumo gerado por IA
  pautas      Json? // Pautas estruturadas (array de objetos)
  decisoes    Json? // Decisões tomadas (array de objetos)
  acoes       Json? // Ações/observações estruturadas (array de objetos)
  observacoes String? // Observações adicionais (texto simples - legado)

  // Metadados de IA
  geradoPorIa          Boolean? // Indica se foi gerado/processado por IA
  iaUsada              String? // Qual IA foi usada (ex: "Groq", "Claude", "Gemini")
  modeloIa             String? // Modelo específico usado (ex: "llama-3.1-8b-instant")
  custoIa              String? // Custo estimado do processamento
  tempoProcessamentoIa Int? // Tempo de processamento em milissegundos

  // Arquivo original (quando importado)
  arquivoOriginalUrl  String? // URL do arquivo original
  arquivoOriginalNome String? // Nome do arquivo original
  arquivoOriginalTipo String? // Tipo/MIME do arquivo original

  // Novos campos para "Em Processo"
  dataAssinatura     DateTime?
  dataRegistro       DateTime?
  cartorioRegistro   String?
  numeroRegistro     String?
  pendenteAssinatura Boolean   @default(false)
  pendenteRegistro   Boolean   @default(false)

  // Relacionamento com modelo de ata
  modeloAtaId String?

  // Relacionamentos
  criadoPor String
  empresaId String?

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  criador        Usuario              @relation(fields: [criadoPor], references: [id], onDelete: Cascade)
  empresa        Empresa?             @relation(fields: [empresaId], references: [id], onDelete: SetNull)
  modeloAta      ModeloAta?           @relation(fields: [modeloAtaId], references: [id], onDelete: SetNull)
  participantes  AtaParticipante[]
  anexos         AtaAnexo[]
  comentarios    AtaComentario[]
  historico      HistoricoAndamento[]
  prazos         PrazoAcao[]
  logsAlteracoes LogAlteracaoAta[]

  @@index([dataReuniao])
  @@index([status])
  @@index([empresaId])
  @@index([criadoPor])
  @@index([tipo])
}

model AtaParticipante {
  id          String  @id @default(uuid())
  ataId       String
  usuarioId   String?
  nomeExterno String? // Para participantes que não são usuários do sistema
  email       String?
  cargo       String?
  presente    Boolean @default(true)
  observacoes String?

  // Relacionamentos
  ata     AtaReuniao @relation(fields: [ataId], references: [id], onDelete: Cascade)
  usuario Usuario?   @relation(fields: [usuarioId], references: [id], onDelete: SetNull)

  @@index([ataId])
  @@index([usuarioId])
}

model AtaAnexo {
  id             String         @id @default(uuid())
  ataId          String
  nomeArquivo    String
  urlArquivo     String
  tipoArquivo    TipoArquivoAta
  tamanhoArquivo Int?
  mimeType       String?
  uploadedBy     String?
  descricao      String?

  // Relacionamentos
  ata AtaReuniao @relation(fields: [ataId], references: [id], onDelete: Cascade)

  // Metadados
  uploadedAt DateTime @default(now())

  @@index([ataId])
}

model AtaComentario {
  id              String         @id @default(uuid())
  ataId           String
  comentario      String
  tipo            TipoComentario
  autorId         String
  comentarioPaiId String? // Para respostas a outros comentários

  // Relacionamentos
  ata           AtaReuniao      @relation(fields: [ataId], references: [id], onDelete: Cascade)
  autor         Usuario         @relation(fields: [autorId], references: [id], onDelete: Cascade)
  comentarioPai AtaComentario?  @relation("ComentarioRespostas", fields: [comentarioPaiId], references: [id], onDelete: Cascade)
  respostas     AtaComentario[] @relation("ComentarioRespostas")

  // Metadados
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ataId])
  @@index([autorId])
  @@index([comentarioPaiId])
}

// Enums para Atas
enum TipoReuniao {
  ASSEMBLEIA_GERAL
  CONSELHO_DIRETOR
  REUNIAO_ORDINARIA
  REUNIAO_EXTRAORDINARIA
  COMISSAO
  OUTRO
}

enum StatusAta {
  RASCUNHO // Ata em processo de transcrição
  EM_PROCESSO // Ata com histórico de andamento
  FINALIZADA // Ata assinada e registrada
  PUBLICADA // Mantido para compatibilidade (legado)
  ARQUIVADA // Ata arquivada
}

enum TipoArquivoAta {
  DOCUMENTO
  IMAGEM
  PDF
  PLANILHA
  OUTRO
}

enum TipoComentario {
  COMENTARIO
  SUGESTAO
  APROVACAO
  REPROVACAO
}

// =====================================================
// MODELOS PARA SISTEMA DE 3 LINHAS DE ATAS
// =====================================================

model ModeloAta {
  id          String      @id @default(uuid())
  nome        String
  descricao   String?
  tipoReuniao TipoReuniao

  // Estrutura do template
  estrutura  Json // Estrutura esperada da ata (campos, seções)
  exemplo    Json? // Exemplo de ata formatada
  instrucoes String? // Instruções para a IA usar este template

  // Metadados
  ativo     Boolean  @default(true)
  criadoPor String
  empresaId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  criador Usuario      @relation(fields: [criadoPor], references: [id], onDelete: Cascade)
  empresa Empresa?     @relation(fields: [empresaId], references: [id], onDelete: SetNull)
  atas    AtaReuniao[]

  @@index([tipoReuniao])
  @@index([empresaId])
  @@index([ativo])
}

model HistoricoAndamento {
  id    String @id @default(uuid())
  ataId String

  // Dados do histórico
  data        DateTime @default(now())
  acao        String // Ex: "Enviado para assinatura", "Registrado em cartório"
  descricao   String?
  responsavel String? // Nome do responsável pela ação

  // Metadados
  criadoPor String
  createdAt DateTime @default(now())

  ata     AtaReuniao @relation(fields: [ataId], references: [id], onDelete: Cascade)
  criador Usuario    @relation(fields: [criadoPor], references: [id], onDelete: Cascade)

  @@index([ataId])
  @@index([data])
}

model PrazoAcao {
  id    String @id @default(uuid())
  ataId String

  // Dados do prazo
  acaoId        String? // ID da ação relacionada (se houver)
  titulo        String
  descricao     String?
  dataPrazo     DateTime
  dataConclusao DateTime?

  // Status
  status    StatusPrazo @default(PENDENTE)
  concluido Boolean     @default(false)

  // Lembretes
  lembretesEnviados Int       @default(0)
  ultimoLembrete    DateTime?

  // Metadados
  criadoPor String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ata       AtaReuniao      @relation(fields: [ataId], references: [id], onDelete: Cascade)
  criador   Usuario         @relation(fields: [criadoPor], references: [id], onDelete: Cascade)
  lembretes LembretePrazo[]

  @@index([ataId])
  @@index([dataPrazo])
  @@index([status])
  @@index([concluido])
}

model LembretePrazo {
  id        String @id @default(uuid())
  prazoId   String
  usuarioId String

  // Dados do lembrete
  tipo      TipoLembrete
  mensagem  String
  enviado   Boolean      @default(false)
  dataEnvio DateTime?

  // Metadados
  createdAt DateTime @default(now())

  prazo   PrazoAcao @relation(fields: [prazoId], references: [id], onDelete: Cascade)
  usuario Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([prazoId])
  @@index([usuarioId])
  @@index([enviado])
}

enum StatusPrazo {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDO
  VENCIDO
  CANCELADO
}

enum TipoLembrete {
  EMAIL
  NOTIFICACAO_SISTEMA
  AMBOS
}

enum TipoAlteracaoAta {
  CRIACAO
  EDICAO
  EXCLUSAO
  MUDANCA_STATUS
  ADICAO_HISTORICO
  EDICAO_HISTORICO
  EXCLUSAO_HISTORICO
  ADICAO_PRAZO
  EDICAO_PRAZO
  EXCLUSAO_PRAZO
  CONCLUSAO_PRAZO
  ADICAO_COMENTARIO
  EDICAO_COMENTARIO
  EXCLUSAO_COMENTARIO
  UPLOAD_ARQUIVO
  DOWNLOAD_ARQUIVO
}

// =====================================================
// PREFERÊNCIAS DE NOTIFICAÇÃO
// =====================================================

model PreferenciaNotificacao {
  id           String  @id @default(uuid())
  usuarioId    String  @unique
  emailAtivo   Boolean @default(true)
  sistemaAtivo Boolean @default(true)
  pushAtivo    Boolean @default(false)

  // Frequência de lembretes
  lembrete3Dias   Boolean @default(true)
  lembrete1Dia    Boolean @default(true)
  lembreteHoje    Boolean @default(true)
  lembreteVencido Boolean @default(true)

  // Horários de notificação
  horarioInicio String   @default("08:00")
  horarioFim    String   @default("18:00")
  diasSemana    String[] @default(["segunda", "terca", "quarta", "quinta", "sexta"])

  // Tipos de eventos
  notificarPrazos      Boolean @default(true)
  notificarHistorico   Boolean @default(false)
  notificarComentarios Boolean @default(false)
  notificarStatus      Boolean @default(true)

  // Resumos
  resumoDiario         Boolean @default(false)
  resumoSemanal        Boolean @default(true)
  diaResumoSemanal     String  @default("segunda")
  horarioResumoSemanal String  @default("09:00")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

// =====================================================
// PUSH NOTIFICATIONS
// =====================================================

model PushSubscription {
  id        String   @id @default(uuid())
  usuarioId String
  endpoint  String
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, endpoint])
  @@index([usuarioId])
}

// =====================================================
// LOG DE ALTERAÇÕES
// =====================================================

model LogAlteracaoAta {
  id            String           @id @default(uuid())
  ataId         String
  usuarioId     String
  tipoAlteracao TipoAlteracaoAta
  campo         String? // Nome do campo alterado
  valorAnterior String? // Valor antes da alteração (JSON se necessário)
  valorNovo     String? // Valor após alteração (JSON se necessário)
  descricao     String? // Descrição da alteração
  metadata      Json? // Dados adicionais (IP, user agent, etc.)
  createdAt     DateTime         @default(now())

  ata     AtaReuniao @relation(fields: [ataId], references: [id], onDelete: Cascade)
  usuario Usuario    @relation(fields: [usuarioId], references: [id])

  @@index([ataId])
  @@index([usuarioId])
  @@index([tipoAlteracao])
  @@index([createdAt])
}

// =====================================================
// CONFIGURAÇÕES E E-MAIL
// =====================================================

model ConfiguracaoEmail {
  id         String          @id @default(uuid())
  nome       String // Nome da configuração (ex: "Principal", "Backup")
  host       String // smtp.gmail.com
  porta      Int // 587, 465, 25
  autenticar Boolean         @default(true)
  usuario    String // e-mail
  senha      String // senha criptografada
  copiasPara String? // e-mails separados por ponto e vírgula
  ativo      Boolean         @default(true)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  logsEnvio  LogEnvioEmail[]

  @@index([ativo])
}

model LogEnvioEmail {
  id             String            @id @default(uuid())
  configuracaoId String
  destinatario   String
  assunto        String
  corpo          String? // HTML ou texto
  status         StatusEnvioEmail  @default(PENDENTE)
  erro           String?
  tentativas     Int               @default(0)
  enviadoEm      DateTime?
  createdAt      DateTime          @default(now())
  configuracao   ConfiguracaoEmail @relation(fields: [configuracaoId], references: [id], onDelete: Cascade)

  @@index([configuracaoId])
  @@index([status])
  @@index([createdAt])
  @@index([destinatario])
}

enum StatusEnvioEmail {
  PENDENTE
  ENVIADO
  FALHA
  CANCELADO
}
